<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WorldAR — Unity WebGL + Browser Camera + Zappar</title>

  <style>
    html,body{margin:0;height:100%;background:#000;font-family:system-ui,Arial}
    /* Камерын видео фон (хүсвэл opacity тавьж болно) */
    #video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;transform:scaleX(-1)}
    /* Unity canvas — ил тод фон */
    #unity-canvas{position:fixed;inset:0;width:100vw;height:100vh;background:transparent;z-index:1}
    /* Доод талын товчлуурууд */
    #ui{position:fixed;left:0;right:0;bottom:14px;z-index:2;display:flex;gap:8px;justify-content:center}
    button{padding:10px 14px;border:0;border-radius:12px;font-weight:700}
  </style>

  <!-- Zappar (low-level JS SDK) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@zappar/zappar@latest/dist/zappar.umd.min.js"></script>
  <!-- Unity loader (Unity build хийхэд автоматаар үүснэ) -->
  <script defer src="Build/Build.loader.js"></script>
</head>
<body>
  <!-- Камерын видео (фон) -->
  <video id="video" playsinline autoplay muted></video>

  <!-- Unity canvas -->
  <canvas id="unity-canvas" tabindex="-1"></canvas>

  <!-- Удирдлага -->
  <div id="ui">
    <button id="btnStart">Start Camera</button>
    <button id="btnPlace">Place / Lock</button>
  </div>

  <script>
  (() => {
    let unityInstance = null;
    let gl = null;

    // ---------- 1) Unity WebGL эхлүүлэх ----------
    createUnityInstance(document.getElementById('unity-canvas'), {
      dataUrl: "Build/Build.data.unityweb",
      frameworkUrl: "Build/Build.framework.js.unityweb",
      codeUrl: "Build/Build.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "Company",
      productName: "WorldAR",
      productVersion: "1.0"
    }).then(instance => {
      unityInstance = instance;
      // Unity-ийн WebGL контекст (Zappar-д зайлшгүй хэрэгтэй)
      gl = (unityInstance.Module && unityInstance.Module.ctx)
        || document.getElementById('unity-canvas').getContext('webgl2')
        || document.getElementById('unity-canvas').getContext('webgl');
      zapparInit();
    });

    // ---------- 2) Zappar + Browser camera ----------
    async function zapparInit(){
      // Zappar global ачаалтал хүлээе
      await new Promise(r=>{
        if (window.Zappar) return r();
        const t=setInterval(()=>{ if (window.Zappar){ clearInterval(t); r(); } },20);
      });

      const pipeline = new Zappar.Pipeline();
      if (gl) pipeline.glContextSet(gl);

      const video = document.getElementById('video');
      let mediaStream = null;

      // <video> → Pipeline (камерын frame-үүдийг feed хийнэ)
      const htmlSrc = new Zappar.HTMLElementSource(pipeline, video);

      // World tracking
      const tracker = new Zappar.InstantWorldTracker(pipeline);
      let placeMode = false; // эхэнд байрлуулахыг ON болгоно

      // Камер асаах (user gesture дотор байх ёстой — iOS)
      document.getElementById('btnStart').addEventListener('click', async () => {
        if (!mediaStream){
          mediaStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } }, audio: false
          });
          video.srcObject = mediaStream;
        }
        await video.play();   // playsinline + gesture
        htmlSrc.start();      // pipeline руу frame feed эхлүүлнэ
        placeMode = true;
        raf();                // render/update цикл
      }, {passive:true});

      // Байршуулалт түгжих/суллах
      document.getElementById('btnPlace').addEventListener('click', () => {
        placeMode = !placeMode;
      }, {passive:true});

      // Background → foreground үед iOS видео pause-дахыг сэргээх
      document.addEventListener('visibilitychange', ()=>{
        if (!document.hidden && video.srcObject) video.play().catch(()=>{});
      });

      // ---------- 3) Processing цикл ----------
      const SEND_INTERVAL_MS = 16; // 60fps хүртэл throttle
      let lastSentAt = 0;

      function raf(){
        // Энэ дарааллыг баримтал: эхлээд processGL, дараа нь frameUpdate
        pipeline.processGL();    // 1)
        pipeline.frameUpdate();  // 2)

        // Байршуулж байх горимд anchor-аа камерын өмнө сүүлдүүлнэ
        if (placeMode) tracker.setAnchorPoseFromCameraOffset(0, 0, -1.5);

        // Камер ба anchor поз
        const camPose = pipeline.cameraPoseWithAttitude();
        const m = tracker.anchor.pose(camPose, /*mirror*/ false); // Float32Array(16), column-major 4x4

        // Матриц → TRS (Unity-д ээлтэй payload)
        const pose = matrixToTRS(m);

        // Unity руу илгээх
        const now = performance.now();
        if (now - lastSentAt >= SEND_INTERVAL_MS) {
          if (unityInstance) {
            unityInstance.SendMessage("WorldAnchor", "OnPoseJson", JSON.stringify(pose));
          }
          lastSentAt = now;
        }

        requestAnimationFrame(raf);
      }

      // Column-major 4x4 → position + quaternion (+scale)
      function matrixToTRS(m){
        const px = m[12], py = m[13], pz = m[14];

        const m00=m[0], m01=m[4], m02=m[8];
        const m10=m[1], m11=m[5], m12=m[9];
        const m20=m[2], m21=m[6], m22=m[10];

        const tr = m00 + m11 + m22;
        let qw,qx,qy,qz;
        if (tr > 0){
          const S = Math.sqrt(tr + 1.0) * 2;
          qw = 0.25*S; qx = (m21 - m12)/S; qy = (m02 - m20)/S; qz = (m10 - m01)/S;
        } else if (m00 > m11 && m00 > m22){
          const S = Math.sqrt(1.0 + m00 - m11 - m22) * 2;
          qw = (m21 - m12)/S; qx = 0.25*S; qy = (m01 + m10)/S; qz = (m02 + m20)/S;
        } else if (m11 > m22){
          const S = Math.sqrt(1.0 + m11 - m00 - m22) * 2;
          qw = (m02 - m20)/S; qx = (m01 + m10)/S; qy = 0.25*S; qz = (m12 + m21)/S;
        } else {
          const S = Math.sqrt(1.0 + m22 - m00 - m11) * 2;
          qw = (m10 - m01)/S; qx = (m02 + m20)/S; qy = (m12 + m21)/S; qz = 0.25*S;
        }
        return { px, py, pz, qx, qy, qz, qw, sx:1, sy:1, sz:1 };
      }
    }
  })();
  </script>
</body>
</html>
